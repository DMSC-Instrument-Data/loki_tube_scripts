import unittest
import os
import data_reduction_scripts.FullDataReduction as dr
from mantid.simpleapi import *
import numpy as np


class LokiSANSTestReduction(unittest.TestCase):
    resX = [0.00832919, 0.00899552, 0.00971516, 0.01049238, 0.01133177, 0.01223831,
            0.01321737, 0.01427476, 0.01541674, 0.01665008, 0.01798209, 0.01942065,
            0.02097431, 0.02265225, 0.02446443, 0.02642159, 0.02853531, 0.03081814,
            0.03328359, 0.03594628, 0.03882198, 0.04192774, 0.04528196, 0.04890451,
            0.05281687, 0.05704222, 0.0616056, 0.06653405, 0.07185677, 0.07760532,
            0.08381374, 0.09051884, 0.09776035, 0.10558117, 0.11402767, 0.12314988,
            0.13300187, 0.14364202, 0.15513338, 0.16754405, 0.18094758, 0.19542339,
            0.21105726, 0.22794184, 0.24617718, 0.26587136, 0.28714107, 0.31011235,
            0.33492134, 0.36171505, 0.39065225, 0.42190443, 0.45565679, 0.49210933,
            0.53147808, 0.57399632]
    resY = [1.61005301, 1.75089192, 1.79429976, 1.8746441, 1.92545673, 1.93741107,
            1.99166609, 2.02458598, 2.02502942, 2.0403141, 2.0160953, 1.98775203,
            1.94305294, 1.89723024, 1.82467133, 1.7470841, 1.65331334, 1.56382041,
            1.4667164, 1.3462504, 1.23622578, 1.12229379, 1.01315368, 0.90894688,
            0.81076523, 0.72069886, 0.6361748, 0.56225669, 0.49123168, 0.43378626,
            0.38024771, 0.33318311, 0.29364864, 0.25609552, 0.22626462, 0.19784378,
            0.17242716, 0.15128045, 0.13424842, 0.11897575, 0.10605954, 0.09582999,
            0.08620068, 0.0799104, 0.06924081, 0.06262072, 0.05787713, 0.05235645,
            0.04734671, 0.04428344, 0.04215488, 0.0372213, 0.03449243, 0.03342835,
            0.03272687]

    def test_run_script(self):
        folder = os.path.dirname(__file__)
        folder += "/test_data/"
        directBeamFile = 'DirectBeam_20feb_full_v3.dat'
        moderatorFile = 'ModeratorStdDev_TS2_SANS_LETexptl_07Aug2015.txt'
        idf = "LARMOR_Definition.xml"
        mask = "Mask_full.xml"
        lokiReduction = dr.LokiSANSTestReduction(idf, mask, 49338, 49339, 49334, 49335, 49335, folder, directBeamFile,
                                                 moderatorFile)
        lokiReduction.execute()

        resultWs = mtd['reduced']
        x = resultWs.extractX()
        y = resultWs.extractY()

        self.assertTrue(np.allclose(x[0], self.resX))
        self.assertTrue(np.allclose(y[0], self.resY))


if __name__ == '__main__':
    unittest.main()
