import unittest
import os
import data_reduction_scripts.FullDataReduction as dr
from mantid.simpleapi import *
import numpy as np


class LokiSANSTestReduction(unittest.TestCase):
    resX = [0.00832919, 0.00899552, 0.00971516, 0.01049238, 0.01133177, 0.01223831,
            0.01321737, 0.01427476, 0.01541674, 0.01665008, 0.01798209, 0.01942065,
            0.02097431, 0.02265225, 0.02446443, 0.02642159, 0.02853531, 0.03081814,
            0.03328359, 0.03594628, 0.03882198, 0.04192774, 0.04528196, 0.04890451,
            0.05281687, 0.05704222, 0.0616056, 0.06653405, 0.07185677, 0.07760532,
            0.08381374, 0.09051884, 0.09776035, 0.10558117, 0.11402767, 0.12314988,
            0.13300187, 0.14364202, 0.15513338, 0.16754405, 0.18094758, 0.19542339,
            0.21105726, 0.22794184, 0.24617718, 0.26587136, 0.28714107, 0.31011235,
            0.33492134, 0.36171505, 0.39065225, 0.42190443, 0.45565679, 0.49210933,
            0.53147808, 0.57399632]
    resY = [1.03885019, 1.14146068, 1.18013521, 1.24700277, 1.29227034, 1.31168382,
            1.36075161, 1.39429835, 1.40540199, 1.42685144, 1.41914659, 1.40775133,
            1.38486294, 1.3607308, 1.31666522, 1.2676489, 1.2058572, 1.14510815,
            1.07800314, 0.99288872, 0.91474027, 0.83279964, 0.75379223, 0.67829177,
            0.60719695, 0.54163367, 0.47975321, 0.42545583, 0.37294651, 0.33049571,
            0.29067034, 0.25558512, 0.2260578, 0.19780949, 0.17547901, 0.15398061,
            0.13468029, 0.11853633, 0.10558539, 0.09378188, 0.08383174, 0.07599453,
            0.06857472, 0.06397675, 0.05554994, 0.05014159, 0.0464714, 0.04198388,
            0.03787574, 0.03537616, 0.03358554, 0.02943651, 0.02737925, 0.02657937,
            0.02599546]

    def test_run_script(self):
        folder = os.path.dirname(__file__)
        folder += "/test_data/"
        directBeamFile = 'DirectBeam_20feb_full_v3.dat'
        moderatorFile = 'ModeratorStdDev_TS2_SANS_LETexptl_07Aug2015.txt'
        idf = "LARMOR_Definition.xml"
        mask = "Mask_full.xml"
        lokiReduction = dr.LokiSANSTestReduction(idf, mask, 49338, 49339, 49334, 49335, 49335, folder, directBeamFile,
                                                 moderatorFile)
        lokiReduction.execute()

        resultWs = mtd['reduced']
        x = resultWs.extractX()
        y = resultWs.extractY()

        self.assertTrue(np.allclose(x[0], self.resX))
        self.assertTrue(np.allclose(y[0], self.resY))


if __name__ == '__main__':
    unittest.main()
